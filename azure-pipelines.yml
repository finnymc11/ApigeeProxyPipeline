trigger: none  # run manually; you can change to trigger on branch if you want

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Apigee org & env
  APIGEE_ORG: 'finbar-project'
  APIGEE_ENV: 'eval'
  PROXY_NAME: 'finbar-app2'
  PROXY_DIR: 'apigee/finbar-app2'
  PROXY_ZIP: 'finbar-app2.zip'

  # GCP project for Apigee
  GCP_PROJECT_ID: 'finbar-project'

steps:
  - task: Bash@3
    displayName: 'Install gcloud SDK'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        echo "Installing gcloud..."
        sudo apt-get update -y
        sudo apt-get install -y apt-transport-https ca-certificates gnupg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        sudo apt-get update -y && sudo apt-get install -y google-cloud-sdk

        echo "gcloud version:"
        gcloud version

  - task: Bash@3
    displayName: 'Authenticate gcloud (service account)'
    inputs:
      targetType: 'inline'
      script: |
        set -e

        echo "Authenticating to Google Cloud using service account..."

        # 1️⃣ Ensure the JSON key is present
        if [ -z "$GCLOUD_SERVICE_ACCOUNT_KEY" ]; then
          echo "ERROR: GCLOUD_SERVICE_ACCOUNT_KEY is not set."
          echo "Make sure it's configured as a secret variable in Azure DevOps."
          exit 1
        fi

        # 2️⃣ Write the JSON key to a file
        echo "$GCLOUD_SERVICE_ACCOUNT_KEY" > ${HOME}/gcloud-key.json

        # 3️⃣ Activate the service account
        echo "Activating service account..."
        gcloud auth activate-service-account --key-file=${HOME}/gcloud-key.json

        # 4️⃣ Set the project
        echo "Setting project to $(GCP_PROJECT_ID)..."
        gcloud config set project $(GCP_PROJECT_ID)

        # 5️⃣ Show accounts for debugging
        echo "Current gcloud accounts (one should be ACTIVE):"
        gcloud auth list

        echo "gcloud authentication completed successfully."
    env:
      GCLOUD_SERVICE_ACCOUNT_KEY: $(GCLOUD_SERVICE_ACCOUNT_KEY)  # secret variable in Azure DevOps

  - task: Bash@3
    displayName: 'Check gcloud components (optional)'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        gcloud components list || true

  - task: Bash@3
    displayName: 'Zip Apigee proxy bundle'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        echo "Zipping Apigee proxy from $(PROXY_DIR)..."
        cd "$(PROXY_DIR)"
        zip -r "../../$(PROXY_ZIP)" apiproxy
        cd -
        echo "Created zip:"
        ls -la "$(PROXY_ZIP)"

  - task: Bash@3
    displayName: 'Import proxy into Apigee'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        echo "Importing proxy $(PROXY_NAME) into Apigee org $(APIGEE_ORG)..."

        ACCESS_TOKEN=$(gcloud auth print-access-token)

        if [ -z "$ACCESS_TOKEN" ]; then
          echo "ERROR: Failed to get access token from gcloud."
          gcloud auth list
          exit 1
        fi

        HTTP_STATUS=$(curl -s -o response.json -w "%{http_code}" \
          -X POST \
          -H "Authorization: Bearer ${ACCESS_TOKEN}" \
          -H "Content-Type: multipart/form-data" \
          -F "file=@$(PROXY_ZIP)" \
          "https://apigee.googleapis.com/v1/organizations/$(APIGEE_ORG)/apis?name=$(PROXY_NAME)")

        echo "HTTP status: $HTTP_STATUS"
        echo "Response body:"
        cat response.json || echo "<no body>"

        if [ "$HTTP_STATUS" -ge 400 ]; then
          echo "Import failed with HTTP $HTTP_STATUS"
          exit 1
        fi

        echo "Proxy import completed."

  - task: Bash@3
    displayName: 'Get latest proxy revision number'
    name: GetRevision
    inputs:
      targetType: 'inline'
      script: |
        set -e
        ACCESS_TOKEN=$(gcloud auth print-access-token)

        if [ -z "$ACCESS_TOKEN" ]; then
          echo "ERROR: Failed to get access token from gcloud."
          gcloud auth list
          exit 1
        fi

        echo "Fetching revisions for $(PROXY_NAME)..."

        REVISIONS=$(curl -s -H "Authorization: Bearer ${ACCESS_TOKEN}" \
          "https://apigee.googleapis.com/v1/organizations/$(APIGEE_ORG)/apis/$(PROXY_NAME)/revisions")

        echo "Revisions: $REVISIONS"

        # Take the highest revision number
        LATEST_REVISION=$(echo "$REVISIONS" | tr -d '[]" ' | tr ',' '\n' | sort -n | tail -1)

        if [ -z "$LATEST_REVISION" ]; then
          echo "ERROR: Could not determine latest revision."
          exit 1
        fi

        echo "Latest revision is: $LATEST_REVISION"

        # Set a pipeline variable for later steps
        echo "##vso[task.setvariable variable=LATEST_REVISION]$LATEST_REVISION"

  - task: Bash@3
    displayName: 'Deploy proxy to Apigee environment'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        ACCESS_TOKEN=$(gcloud auth print-access-token)

        if [ -z "$ACCESS_TOKEN" ]; then
          echo "ERROR: Failed to get access token from gcloud."
          gcloud auth list
          exit 1
        fi

        LATEST_REVISION=$(LATEST_REVISION)

        echo "Deploying proxy $(PROXY_NAME) revision ${LATEST_REVISION} to env $(APIGEE_ENV)..."

        curl -X POST \
          -H "Authorization: Bearer ${ACCESS_TOKEN}" \
          "https://apigee.googleapis.com/v1/organizations/$(APIGEE_ORG)/environments/$(APIGEE_ENV)/apis/$(PROXY_NAME)/revisions/${LATEST_REVISION}/deployments" \
          --fail --silent --show-error

        echo "Deployment triggered."